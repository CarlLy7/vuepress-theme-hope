---
title: MySQL主库故障之后如何进行故障转移
date: 2026-01-26 20:48:48
---


## MySQL主库故障之后如何进行故障转移



首先这个问题要从大方向来说要从三个方向来看，**①故障检测②故障转移③数据一致性检测与同步**

当然大家肯定能猜到，目前市面上肯定是有比较优秀的开源工具的（后面会说），是不需要我们手动去造轮子的。但是面试官问你这个问题的时候肯定是想靠你的思路，也就是问你这些开源工具的实现思路是什么，那么你就需要能够给面试官说出来你的设计思路。

---

#### 故障检测

首先我们肯定要设计一种比较可靠的检测机制，能够**即时且准确**的发现Master故障了，既不能够误判也不能够漏判。

**阶段1: 基础心跳检测**
以一定的时间间隔对Master发起心跳检测，比如以3s作为时间间隔发送心跳

	1. **尝试与Master的3306端口建立TCP连接**
 	2. 如果成功与Master建立了TCP连接，那么可以去**发送轻量级的查询**，比如Select 1 from table;
 	3. **尝试与Master建立SSH连接，去登录Master**
 	4. **同时监控Master机器的CPU利用率、内存利用率、磁盘IO等，这个可以帮助我们更好的判断Master是否真的出现故障**

::: tip

如果在阶段1的**任何一个环节成功了**，那么就认为Master是没有故障的

:::



**阶段2：故障怀疑**

如果我们阶段1的三个环节都失败了，那么可以调整时间间隔，由原来的3s变为1s,如果在重复阶段1的过程中有一步成功了，那么依然不认为Master故障，可能是因为网络抖动引起。如果在经历了N次重试之后，阶段1的三步都没有成功，那么可以进行阶段2了。

与所有的Slave建立SSH连接，在Slave上执行```SHOW SLAVE STATUS```,判断一下Slave是否能够成功与Master建立连接以及是否能够拉取到Binlog日志，如果所有的Slave都与Master连接超时，并且都没有获取到Binlog日志，那么就认为Master发生故障了。



::: tip

补充一下：我们要借鉴Redis Sentinel的思路，我们的这个检测以及进行故障转移的”Sentinel节点“，也要部署多个，防止发生”主观下线“的问题。

:::



---



#### 故障转移

在经过前面的故障检测之后，我们可以认为Master发生故障了，那么接下来就是进行故障转移，从Slave中选择一个来作为新的Master。

另外进行故障转移的时候可以分为两类。第一类：**人工处理**。第二类：**自动转移**。

其中人工处理就是人工去选择一个Slave然后将它作为新的Master，这里就不详细说明了。下面详细说一下自动转移。这个肯定用的比较多，因为我们的目的其实是想实现自动化处理，**将人”解放出来“，避免007**。

自动转移：

1. 首先要先通过**Raft算法**在我们的”Sentinel集群“中选出一个Leader来进行故障转移
2. **可以在Slave中选择Binlog同步程度最高的Slave来作为新的Master**

但是此时可能还面临一个问题，**脑裂**问题。

::: tip

脑裂问题：因为网络原因导致Master和Slave之间发生了网络分区，Slave服务连接到Master但是此时的Master没有宕机，此时认为Master宕机了，选择了一个新的Master，导致MySQL集群中出现了两个Master的情况。

:::



我们还需要设计脑裂问题的防御手段

1. **设计”Sentinel集群“，可以有效的降低风险**
2. **通过 脚本连接Master服务器，然后将Master强制设置为只读**
3. **通过脚本连接Master服务器，然后强制杀掉3306端口的进程**

---



#### 数据一致性检测与同步

我们完成故障转移之后还需要进行数据一致性检测与同步。因为老Master在宕机之前可能还执行了一些事务，只不过那些事务没有通过Binlog同步给Slave,所以Slave中可能会缺失一些数据。

**等老Master恢复后需要将它当时已经执行的事务但是没有通过Binlog同步给Slave的事务在新的Master中进行重放**。

这个的实现思路可以利用Mysql自带的**GTID（全局事务ID）**，MySQL**自带**了全局事务ID，给每一个事务分配一个全局的唯一ID，我们可以遍历老Master的所有GTID然后和新的Master的GTID进行**比较**，只需要去重放新Master中**不存在的**GTID就可以了。



---



#### 开源的故障转移工具推荐

1. **MGR**
   	MySQL 8.0.22之后自带的故障转移机制，如果你的数据库选择的版本达到了要求，并且是新建MySQL集群的化可以考虑这个

2. **Orchestrator**
   	基于Go语言编写的，适合现有的MySQL集群进行故障转移，有对应的Web界面，交互好，主打**拓扑可视化 + 智能故障切换 + 复制管理**，社区活跃、部署灵活。

3. **MHA**
   老牌 Perl 脚本集，专注主库故障后的自动切换，强调**数据一致性与差异日志补偿**。Mysql5.x版本自带。



上面说的开源的这些故障转移的工具，其实他们的设计思路和我们上面说的大同小异。



