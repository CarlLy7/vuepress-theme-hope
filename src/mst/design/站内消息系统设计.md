---
title: 站内消息系统设计
date: 2023-12-01
icon: eos-icons:subscription-management
---



## 站内消息系统设计



#### 什么是站内消息系统？

简单的来说就是负责一个系统内的消息通知的系统就是站内消息系统。

举个例子：b站的系统消息，关注、私信、点赞都是站内消息

![b站样例](https://cdn.jsdelivr.net/gh/EyeDroplyq/myblog-img@master/b站样例.png)





#### 设计方案

对于一个系统来说，站内的消息是需要进行分类的，我感觉可以按照b站的这个来分类，分为 **系统通知**、**由用户行为导致的回复、@、点赞通知** 



##### 系统通知消息

对于系统通知消息来说，一般是由后台系统发出的消息，但是也是需要进行分类的，按照消息的发放范围可以分为给单个用户发送通知、给全体用户发送通知、给VIP用户发送通知等等，具体的由你的系统业务来确定。

首先先来看一下数据表的设计，然后再说后序的设计

两张表，t_system_notice表：用来记录后台系统发出的消息 

​			   t_user_notice表：用来记录用户接收的消息。 如果用户想要看到消息的内容需要到这个表中进行消息的拉取



t_system_notice

|      字段名       |    类型     |                             备注                             |
| :---------------: | :---------: | :----------------------------------------------------------: |
| system_message_id | Big Integer |                          系统消息id                          |
|       title       |   varchar   |                             标题                             |
|      content      |   varchar   |                             内容                             |
|      status       |     int     |             是否被拉取过（0：未拉取 1：已拉取）              |
|       type        |   varchar   |     发送范围(single:单个用户,all:全体用户,VIP:全体会员)      |
|    receiver_id    |   varchar   | 接收者id(如果type=single的话为对应用户的id,如果是all或者VIP的话用0来代表) |
|   publish_time    |  timestamp  |                           发布时间                           |
|   publisher_id    |   varchar   |                       发送的管理员的id                       |



t_user_notice

|      字段名       |    类型     |           备注           |
| :---------------: | :---------: | :----------------------: |
|  user_message_id  | Big Integer |          消息id          |
|      status       |     int     | 读取状态(0:未读 1：已读) |
| system_message_id | Big Integer |        系统消息id        |
|    receive_id     |   varchar   |         接收者id         |
|     pull_time     |  timestamp  |         读取时间         |



针对不同的发送范围，我设计不同的通知方案：

​	对于单个用户的范围的这种消息，可以直接写入t_user_notice这个表中，但是还要去通知它有消息的到来

​	对于VIP这种特定人群的范围：这种用户数相对于整个系统的用户来说，肯定占了小部分，所以可以使用mq，先将消息放到mq中，然后慢慢的给t_user_notice这个表中插入。如果VIP用户数不大的话，也可以直接插入t_user_notice表中，不需要经过mq,这就要由你系统的实际情况来确定了。同时我们可以使用一个session池来缓存当前在线的VIP用户，当插入完数据之后，通知他有新消息了。没有登录的就不需要立刻通知了，等上线后会去拉取所以上线后会看到的。

​	对于全体人员的范围：这种范围的用户数是非常大的，所以有下面的几种方案：

​	1、使用多线程+批量插入的方案来分批的处理数据，分批来插入到t_user_notice中

​	2、如果对实时性要求不高，为了降低并发插入的压力，可以放到mq中慢慢消费慢慢去插入

​	3、如果感觉对一个表t_user_notice的插入压力太大的话，我们可以进行表的拆分，按照用户的user_id来进行hash操作，哈希值相同的放到一个表中，所以需要用到了分库分表的技术,分库分表之后的t_user_notice中只需要存放一条这个消息就可以了,因为这个表中的用户接收到的是同一条消息,所以去这个表中读取就可以了。同时可以使用session池来缓存当前在线的用户，插入之后通知在线的用户有新消息了。





##### 由用户行为导致的点赞、评论、@消息

由用户行为导致的点赞、评论、@类型的消息都是点对点的消息，所以一般都是直接插入表中

表的设计

t_event_message

|      字段名      |    类型     |              备注               |
| :--------------: | :---------: | :-----------------------------: |
| event_message_id | Big Integer |             消息id              |
|   source_type    |     Int     | 消息来源的类型(0:文章 1：评论)  |
|    source_id     | BigInteger  |   消息来源id,如文章id,评论id    |
|  source_content  |   varchar   | 回复或者点赞或者@的源消息的内容 |
|       url        |   varchar   |        来源消息的url地址        |
|   publisher_id   | BigInteger  |          消息发送者id           |
|   receiver_id    | BigInteger  |          消息接收者id           |
|      status      |     Int     |     是否读取(0:未读 1:已读)     |
|   publish_time   |  timestamp  |          消息发布时间           |



消息聚合，消息聚合一般就是当一条评论有多个点赞，或者多个回复、或者多个@的时候，一般会通过分组统计一个数量，给用户一个共xx个点赞这种通知，需要做的就是进行分组通知数量。

​	当然可以根据你们项目的实际需要对上面的表进行拆分，分成点赞表、评论表、@表等

##### 私信

私信的设计就是点对点的消息，其实就是一个聊天系统，所以就涉及到聊天系统的设计了，这里就不做具体的阐述了，可以使用netty来做一个聊天室的系统嵌入进入。实时性要好。



##### 开关的设置

![b站消息设置](https://cdn.jsdelivr.net/gh/EyeDroplyq/myblog-img@master/b站消息设置.png)



我们也可以按照b站这种设计来对消息的提醒设置一些开关，可以由用户来确定接收什么类型的消息通知。

表的设计

t_message_notice_switch

|           字段名           |    类型    |         备注         |
| :------------------------: | :--------: | :------------------: |
|          user_id           | BigInteger |        用户id        |
|        like_message        |  Boolean   |   是否接收点赞消息   |
|       reply_message        |  Boolean   |   是否接收评论消息   |
|         at_message         |  Boolean   |    是否接收@消息     |
|      stranger_message      |  Boolean   |  是否接收陌生人消息  |
| private_messages_intercept |  Boolean   | 是否开启私信智能拦截 |
|       message_notice       |  Boolean   |   是否开启消息提醒   |



**上述仅是我个人的思想，有不对或者不符合你们项目业务的地方请指出**



END.....







