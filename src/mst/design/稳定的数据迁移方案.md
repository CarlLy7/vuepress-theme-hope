---
title: 稳定的数据迁移方案
date: 2023-11-26
icon: eos-icons:storage-class
---



## 稳定的数据迁移方案

#### 数据迁移一般包括从一个MySQL搬到另一个MySQL；或者是从Redis搬到MySQL；亦或者是从MySQL迁移到TiDB

发生数据迁移的几种情况：

- 1、原来存储设备的容量不足，需要进行分库分表了

-   2、刚开始构建项目的时候没有进行系统拆分，后面需要对系统进行服务的拆分

-   3、原来的存储系统存在缺陷，更换了新的存储基础设施或者新的结构


#### 业界一个通用的大方案，如下图
![数据迁移业界通用方案](https://cdn.jsdelivr.net/gh/EyeDroplyq/myblog-img@master/数据迁移通用方案.png)


##### 1、增量双写

简单来说就是老库和新库同时进行写操作，但是要保证以老库中的数据为准。而且如何写也是一个细节问题。

一般有两种写的方式，第一种就是同步写，另一种就是异步写。

对于同步写这种方案，要注意如果老库中的数据写失败了，那么新库中肯定是不能写的。而且我们应该启动一个异步任务去对比新库和老库中的差异，用老库的数据来覆盖掉这个差异。

对于异步写这种方案，要注意的是写入的顺序，应该是先写入老库，老库写入完成之后发一个消息去写新库。

不管是同步写还是异步写，都要关注新库的容量和性能问题是否符合我们的预期。

#### 2、存量迁移

存量迁移顾名思义就是将老库中剩余的数据同步到新库上。不管是通过日志回放还是脚本扫描都是逐步的过程。


#### 3、双读

双写和存量迁移完成之后就可以进行双读了，这一步也是非常重要的一个环节。下面来详细说说这个步骤，其实这个步骤还是读取的老库的数据然后返回，但是同时读取完老库的数据之后起一个异步任务去读取新库，然后将新库中的结果和老库的结果进行对比，就可以看到新库的性能和效果了。如果双读做的好可以避免很多线上事故。

#### 4.切读

如果经过双读后新库和老库没有差异，那么就可以将读请求放到新库上了。但是注意双写不能停，这样可以给我们一个兜底的方案，如果此时双写停了的话，那么故障之后数据就没有了。

#### 5.下掉老存储

如果经过上面的四个步骤之后都没有问题，就可以将老存储去掉了，全部使用新的存储系统。

END
