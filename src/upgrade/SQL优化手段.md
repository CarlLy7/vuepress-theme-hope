---
title: SQL优化手段
date: 2023-12-01
icon: id-card-clip
---



## SQL优化手段



#### 1、避免使用select*

原因如下

- select*会消耗更多的cpu资源
- select * 会返回更多的无用数据，增加网络带宽的开销以及数据传输时间，尤其是一个大属性（blob、varchar、text）
- select*不能使用MySQL中的覆盖索引了，而覆盖索引又是速度比较快的一种索引，也是MySQL推荐的一种索引



#### 2、分页优化

limit offset size这个语句中如果数据量小的话速度挺快，但是如果数据量很大达到了百万甚至千万级别的话，就很慢了

使用子查询来优化，对于limit offset size中的offset的确定我们可以使用一个子查询，比如

```sql
select id,name,age from user where id>=(select id from user limit 10000) limit 10;
```



#### 3、尽量避免多表join

阿里代码规范中强制要求，如果超过三张表就不可以使用join操作了。并且规定在使用join的时候，join的字段必须有索引并且join的这个字段的类型是一致的。



为了避免多表的join操作，也是我在工作中常用的就是将一个复杂的可能需要join四五张表的步骤抽离，分成多个步骤去查，而不是一次性join四五个表完成对应的功能，这样就可以在一定程度上减少数据库的压力，提高性能。



#### 4、不使用外键和级联操作

阿里代码规范中强制规定了，不得使用外键和级联操作。对于数据库的外键概念应该在应用层处理。

不使用外键和级联操作的原因主要是使用外键会影响插入的速率。级联操作是强阻塞的，使用级联操作会带来更新风暴的风险。



#### 5、选择合适的字段类型

字段类型一定要选择合适，不要过大会造成浪费，当然也不能过小。

举个例子：对于IP地址来说，我们可以使用整型来存储，因为MySQL中有整型转IP地址以及IP地址转整型的函数，对应着INET_ATON()和INET_NTOA()

对于金额字段使用decimal，可以保证数据的精度，不会带来精度丢失。

如果能确定一个整型都是非负数的话，使用无符号整型，不要使用整型，因为无符号整型相比于有符号整型来说，正数范围大了一倍。

对于日期类型的字段，可以使用Date、TimeStamp、数值型来存储，但是不可以使用字符串来存储。其中不同的日期类型也是有所不同的。对于Date来说不携带时区信息，对于TimeStamp和数值型来说是携带时区信息的。



#### 6、尽量用UNION ALL替代UNION

UNION会将两个结果集放到一个中间表中然后进行去重处理。而UNION ALL不会进行去重处理。所以UNION ALL比UNION的速率快，对cpu的消耗也少。但是具体使用哪个还是要根据业务需求来决定。



#### 7、批量操作

对于大数据量的sql操作，尽量不要单条循环执行，那样对数据库的访问次数太多，压力也太大，而是要使用批量操作来替代单条操作。



#### 8、正确使用索引（**）

如何选择合适的属性建立索引

1、不为null的字段可以建立索引，因为如果一个字段容易为null的话，首先null不容易维护，另外null值容易造成索引失效

2、频繁查询的字段

3、作为查询条件的字段

4、join查询的时候作为关联的字段



对于那种频繁进行修改的字段不应该建立索引，因为索引的维护花销也是很大的，如果一个索引一直更新的话维护的成本是很高的。



尽可能的考虑建立联合索引而不是单列索引

每一个索引可以理解为底层维护了一棵B+树，如果我们建了多个索引的话，就会有多个B+树，会占用更大的磁盘空间。而且索引变更之后进行维护的时候会比较耗费时间。索引我们尽量考虑使用联合索引来替代单列索引



避免冗余索引

比如有联合索引(a,b)和单列索引（a）,那么这个就是冗余索引，因为命中(a,b)索引的一定会命中(a)这个索引。所以我们应该尽量避免这种冗余索引。



考虑在字符串类型的字段上使用前缀索引替代普通索引

因为前缀索引相对于普通索引来说占用更小的空间。



避免索引失效

- 使用了select*
- 使用了联合索引，但是没有遵循最左匹配原则
- 使用了模糊查询like但是以%开头 例如like "%abc"
- 使用了or 查询，但是or的两边有一个没有使用索引就会导致整个语句都不会使用索引
- 在索引列上进行计算、使用函数、进行类型转换
- 发生了隐式的类型转换

......

及时删除长期未使用的索引

长期不使用的索引我们应该进行删除，因为索引的维护是需要开销的，所以我们应该及时清除长期不使用的索引。



END....

