---
title: 事件驱动模式进行业务解耦
date: 2024-11-06
icon: book-open
---



## 事件驱动模式进行业务解耦

#### 在我们的业务中可能会存在一种业务场景，就是一个方法可能会触发其他的多个后续的操作，并且后续的操作可能还没有顺序要求，对于这种场景，大部分人的做法就是在方法中直接耦合后续的操作，那样会让代码的耦合度越来越高，比较好的一种实现方式是通过事件驱动模式来实现业务代码的解耦。

下面就用一个会员注册的案例来进行讲解。首先一旦用户进行会员注册后，需要去触发执行拉入会员群、发送优惠券、发送消息的方法，下面就用java原生的事件驱动模型去实现。

1. 定义事件引擎接口

```java
/**
 * 事件引擎，负责发布事件
 */
public interface EventEngine {
    /**
     * 发布消息
     * @param event
     */
    void publishEvent(BizEvent event);
}
```

2. 定义事件

```java
import java.util.EventObject;

/**
 * 业务事件
 *
 * @author: carl
 * @date: 2024/11/6
 */

public class BizEvent extends EventObject {
    /**
     * topic
     */
    private final String topic;
    /**
     * 业务id
     */
    private final String bizId;
    /**
     * 数据
     */
    private final Object data;

    public BizEvent(String topic, String bizId, Object data) {
        super(data);
        this.topic = topic;
        this.bizId = bizId;
        this.data = data;
    }

    public String getTopic() {
        return topic;
    }

    public String getBizId() {
        return bizId;
    }

    public Object getData() {
        return data;
    }
}
```

3. 定义事件监听器接口

```java
import com.carl.saTokenDemo.config.BizEvent;

import java.util.EventListener;

public interface BizEventListener extends EventListener {
    /**
     * 是否执行事件
     * @param event
     * @return
     */
    public boolean decide(BizEvent event);

    /**
     * 执行事件
     * @param event
     */
    public void onEvent(BizEvent event);
}
```

4. 创建事件引擎实现类

```java
import com.carl.saTokenDemo.listener.AsyncEventListener;
import com.carl.saTokenDemo.listener.BizEventListener;
import org.springframework.util.CollectionUtils;

import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.concurrent.ThreadPoolExecutor;

/**
 * @author: carl
 * @date: 2024/11/6
 */

public class EventEngineImpl implements EventEngine {
    /**
     * 线程池
     */
    private ThreadPoolExecutor bizExecutor;

    /**
     * 是否异步
     */
    private boolean async;

    /**
     * key：事件的topic   value:一个topic可能会存在多个监听者，所以是监听者列表
     */
    private Map<String, List<BizEventListener>> bizSubscribers = new HashMap<>(16);

    /**
     * @param event
     */
    @Override
    public void publishEvent(BizEvent event) {
        List<BizEventListener> bizEventListeners = bizSubscribers.get(event.getTopic());
        if (CollectionUtils.isEmpty(bizEventListeners)) {
            return;
        }
        for (BizEventListener listener : bizEventListeners) {
            if (listener.decide(event)){
                if (async){
                    // 异步执行
                    bizExecutor.execute(new AsyncEventListener(listener,event));
                }else{
                    listener.onEvent(event);
                }
            }
        }
    }

    public void setBizExecutor(ThreadPoolExecutor bizExecutor) {
        this.bizExecutor = bizExecutor;
    }

    public void setAsync(boolean async) {
        this.async = async;
    }

    public void setBizSubscribers(Map<String, List<BizEventListener>> bizSubscribers) {
        this.bizSubscribers = bizSubscribers;
    }
}
```

5. 创建各种具体事件的监听器的实现类

```java
import com.carl.saTokenDemo.config.BizEvent;
import org.springframework.stereotype.Component;

/**
 * @author: carl
 * @date: 2024/11/6
 */
@Component
public class CouponsHandlerListener implements BizEventListener{
    @Override
    public boolean decide(BizEvent event) {
        return true;
    }

    @Override
    public void onEvent(BizEvent event) {
        System.out.println(Thread.currentThread().getId()+"：线程"+"发送优惠券");
    }
}
import com.carl.saTokenDemo.config.BizEvent;
import org.springframework.stereotype.Component;

/**
 * @author: carl
 * @date: 2024/11/6
 */
@Component
public class MembershipHandlerListener implements BizEventListener{
    @Override
    public boolean decide(BizEvent event) {
        return true;
    }

    @Override
    public void onEvent(BizEvent event) {
        System.out.println(Thread.currentThread().getId()+"：线程"+"邀请会员群");
    }
}
import com.carl.saTokenDemo.config.BizEvent;
import org.springframework.stereotype.Component;

/**
 * @author: carl
 * @date: 2024/11/6
 */
@Component
public class MsgHandlerListener implements BizEventListener{
    @Override
    public boolean decide(BizEvent event) {
        return true;
    }

    @Override
    public void onEvent(BizEvent event) {
        System.out.println(Thread.currentThread().getId()+"：线程"+"发送消息");
    }
}
```

6. 创建事件引擎的配置类

```java
import com.carl.saTokenDemo.listener.BizEventListener;
import com.carl.saTokenDemo.listener.CouponsHandlerListener;
import com.carl.saTokenDemo.listener.MembershipHandlerListener;
import com.carl.saTokenDemo.listener.MsgHandlerListener;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.scheduling.concurrent.CustomizableThreadFactory;

import java.util.Arrays;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.concurrent.LinkedBlockingDeque;
import java.util.concurrent.ThreadPoolExecutor;
import java.util.concurrent.TimeUnit;

/**
 * @author: carl
 * @date: 2024/11/6
 */
@Configuration
public class EventEngineConfig {
    /**
     * 自定义线程池
     */
    private static final ThreadPoolExecutor executor = new ThreadPoolExecutor(5,
            10,
            10,
            TimeUnit.MINUTES,
            new LinkedBlockingDeque<>(100),
            new CustomizableThreadFactory("EVENT_ENGINEE_POOL"));

    /**
     * 初始化事件引擎
     * @param couponsHandlerListener
     * @param membershipHandlerListener
     * @param msgHandlerListener
     * @return
     */
    @Bean("initJobEngine")
    public EventEngine initJobEngine(CouponsHandlerListener couponsHandlerListener, MembershipHandlerListener membershipHandlerListener, MsgHandlerListener msgHandlerListener) {
        Map<String, List<BizEventListener>> eventListeners = new HashMap<>();
        eventListeners.put(EventEngineTopic.JOIN_MEMBERSHIP_GROUP, Arrays.asList(membershipHandlerListener));
        eventListeners.put(EventEngineTopic.ISSUE_COUPONS, Arrays.asList(couponsHandlerListener));
        eventListeners.put(EventEngineTopic.SEND_WELCOME_MSG, Arrays.asList(msgHandlerListener));
        EventEngineImpl eventEngine = new EventEngineImpl();
        // 开启异步处理多个事件
        eventEngine.setAsync(true);
        eventEngine.setBizExecutor(executor);
        eventEngine.setBizSubscribers(eventListeners);
        return eventEngine;
    }
}
```

7. 创建各种topic

```java
/**
 * 事件topic列表
 * @author: carl
 * @date: 2024/11/6
 */

public class EventEngineTopic {
    /**
     * 入会员群
     */
    public static final String JOIN_MEMBERSHIP_GROUP = "joinMembershipGroup";

    /**
     * 发优惠券
     */
    public static final String ISSUE_COUPONS = "issueCoupons";

    /**
     * 推送消息
     */
    public static final String SEND_WELCOME_MSG = "sendWelcomeMsg";
}
```

1. 创建controller方法去测试

```java
import com.carl.saTokenDemo.config.BizEvent;
import com.carl.saTokenDemo.config.EventEngine;
import com.carl.saTokenDemo.config.EventEngineTopic;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;

import javax.annotation.Resource;
import java.util.HashMap;
import java.util.Map;
import java.util.UUID;

/**
 * @author: carl
 * @date: 2024/11/6
 */
@RestController
public class TestController {
    @Resource(name = "initJobEngine")
    private EventEngine engine;

    @GetMapping("/doRegister")
    public String doRegister(String userName, Integer age) {
        Map<String, Object> param = new HashMap<>();
        param.put("username", userName);
        param.put("age", age);
        // 拉入会员群
        engine.publishEvent(new BizEvent(EventEngineTopic.JOIN_MEMBERSHIP_GROUP, UUID.randomUUID().toString(), param));
        // 发送优惠券
        engine.publishEvent(new BizEvent(EventEngineTopic.ISSUE_COUPONS, UUID.randomUUID().toString(), param));
        //发送欢迎消息
        engine.publishEvent(new BizEvent(EventEngineTopic.SEND_WELCOME_MSG, UUID.randomUUID().toString(), param));
        return "注册会员成功";
    }
}
```

8. 测试结果如下

![](https://pic.imgdb.cn/item/672b5e43d29ded1a8cf79540.webp)

9. 项目的目录结构如下

![](https://ik.imagekit.io/carllyq/myblog/image2.png?updatedAt=1730895812869)







END..........

