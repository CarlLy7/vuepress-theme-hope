---
title: 线上故障分析
date: 2023-12-01
icon: cheese
---



## 线上故障分析

### 内存泄漏问题

#### 1.入库内存泄漏

问题总结：因为条件限制，有一个业务是一个查询语句将一个表里面的数据全部查询出来了，然后把内存打爆了，使用jmap -dump导出jvm的整个内存信息之后去分析，发现创建了几十万个对象，直接占用了90%多的内存，导致其他的服务异常慢。


#### 2、ArrayList递归调用addAll()方法导致OOM内存溢出

问题总结：监控系统发现一台机器的内存从20%飙升到60%，并且cpu利用率一直是100%。去查看日志发现了Java.Lang.OutOfMemoryError:Java heap space内存溢出异常。定位到代码出现问题的地方为ArrayList递归调用addAll()方法。出现了递归一直循环的往arrayList中放数据的情况，所以ArrayList一直在进行扩容以及原始数据的复制，所以cpu一直处于100%的情况。

经验：使用递归算法的时候一定要进行自测，进行严格的自测，功能通过不代表代码通过。
2：如果可以预估arrayList的大小的话，在初始化的时候应该直接指定大小。防止频繁的进行扩容和复制数据的操作。

#### 3、读取大的excel文件导致OOM内存溢出

问题分析：因为公司使用的是poi框架，所以我们在读写excel文件的时候，都是使用的userModel用户模式，之前测试的时候也是使用一些大小比较小的excel文件来测试，也是没有问题的，但是当项目上线之后有用户导入了几兆的excel文件，发生故障，查看日志发现报错Java.Lang.OutOfMemoryError:Java heap space 发现占用了1g多的内存。查看文档发现官方推荐在处理大文件的时候使用eventModel基于事件模式的poi.

经验：当你们需要处理大文件的excel的时候推荐使用基于事件模式的poi或者是easyExcel。如果文件特别大的话，推荐使用csv。



#### 4、通用sql查询条件全if导致的内存溢出

问题分析：导致内存溢出的原因这个sql语句查询了两个数据量很大的表，然后后端研发人员在测试的时候使用的数据没有携带任何的参数，然后进行sql查询的时候if标签中的语句都没有满足，所以进行了全表查询，查询的结果数据量太大导致直接把内存占慢了，导致了OOM，内存溢出。



经验：在对这种很大数据量的表进行查询之前，要多做一步参数校验的操作，防止没有任何参数导致的全表查询，不管前端做没做数据的校验我们后端都要自己做一步。不可完全信任前端。因为会有人不通过前端来调用你的这个接口。所以要多加一层校验。



#### 5、导入大文件的时候导致jvm堆栈内存溢出



问题分析：多台服务器接连报警jvm堆栈达到阈值，经过对内存中大对象的分析定位到原因是com.sun.org.apache.xerces.internal.dom.DeferredDocumentImpl 这个对象，占用了大量的内存，进而对com.sun.org.apache.xerces.internal.dom.DeferredDocumentImpl这个对象分析，发现这个对象是poi解析的时候创建的。所以大概率可以确定是导入文件的时候导入了大文件导致，经过查看发现了用户导入了26m的excel文件。

  在项目中使用了poi来处理excel文件，大致的逻辑是：

​		1、用户导入excel文件

​		2、poi对导入的文件进行解析

​		3、遍历导入的数据进行校验，如果不合法给用户返回具体错误位置

​		4、如果合法进行后续的处理，比如插入等操作

​		5、返回导入的结果



经验：1、如果你们公司使用的是poi来进行excel文件的处理的话，如果不想报内存溢出异常的话，可以对导入的文件大小进行限制，可以对文件内容的行数进行一个校验，一般导入的话不超过5000行。5000行大概是600多k，所以文件大小不要超过1M.

​		2、如果你们公司使用的是poi但是你还想让导入的文件大一点，也可以，有一种解决方案就是使用poi官方推荐的基于事件模式的poi来操作大数据量的文件

​		3、选用其他的处理文件的工具，比如easyExcel或者csv



#### 6、没有正确合理使用线程池导致大量创建线程导致内存溢出

问题分析： 有个代码是没次调用这个请求就创建一个线程，线上出来了创建7000多个线程的问题，导致内存溢出了。



经验：合理正确的使用线程池来创建线程，防止系统创建大量的线程而使系统崩溃。





### JVM异常退出问题分析



如果遇到JVM异常退出这个问题的话，首先可以使用下面的思路来排查问题：1、先查看dump文件2、如果没有dump文件查看hs_error_pid.log日志 3、如果也没有hs_error_pid.log日志的话，查看内核日志。







